#!/bin/bash
set -u

readonly NAMESPACE=hadoop-sandbox
readonly bin_dir=$(cd $(dirname $0); pwd)

kubectl get namespace ${NAMESPACE} &> /dev/null
if [ $? -eq 0 ]; then
  read -p "Scrap the current namespace? [y/N]: " scrap
  case "$scrap" in
    y|Y|yes ) ${bin_dir}/cleanup;;
    n|N|no|"" ) ;;
    * ) echo "Please input y or n"; exit 1;;
  esac
fi

set -e

kubectl \
  apply \
  --kustomize=kubernetes \
  --selector="component in (namespace,package)" \
  --wait=true
kubectl --namespace=${NAMESPACE} wait job --all=true --for="condition=complete" --timeout=1800s
kubectl apply --kustomize kubernetes
